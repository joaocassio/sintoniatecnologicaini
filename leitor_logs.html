<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Leitor de Arquivo de Log</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: center;
        }
        th {
            background-color: #f2f2f2;
        }
        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <h1>Leitor de Arquivo de Log</h1>
    <input type="file" id="fileInput" accept=".log" multiple>
    <button onclick="processFiles()">Enviar Arquivos</button>

    <h2>Resultados das Equipes</h2>
    <table id="resultTable" class="hidden">
        <thead>
            <tr>
                <th>POSIÇÃO</th>
                <th>EQUIPES</th>
                <th>ABATES</th>
                <th>PONTOS</th>
                <th>BOOYAH</th>
            </tr>
        </thead>
        <tbody>
            <!-- Conteúdo da tabela será inserido aqui -->
        </tbody>
    </table>

    <h2>Resultados dos Jogadores</h2>
    <table id="playerTable" class="hidden">
        <thead>
            <tr>
                <th>POSIÇÃO</th>
                <th>JOGADOR</th>
                <th>ABATES</th>
            </tr>
        </thead>
        <tbody>
            <!-- Conteúdo da tabela será inserido aqui -->
        </tbody>
    </table>

    <button onclick="exportToExcel()">Exportar para XLSX</button>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script>
        function processFiles() {
            const fileInput = document.getElementById('fileInput');
            const files = fileInput.files;
            if (files.length === 0) {
                alert('Por favor, selecione um ou mais arquivos.');
                return;
            }

            const teamData = {};
            const playerData = {};

            Array.from(files).forEach(file => {
                const reader = new FileReader();
                reader.onload = function(event) {
                    const content = event.target.result;
                    const lines = content.split('\n');

                    lines.forEach(line => {
                        line = line.trim();
                        console.log('Processing line:', line); // Log para depuração

                        // Processamento dos dados das equipes
                        const teamNameMatch = line.match(/^TeamName:\s*(.+?)\s+Rank:\s*(\d+)\s+KillScore:\s*(\d+)\s+RankScore:\s*(\d+)\s+TotalScore:\s*(\d+)$/);
                        if (teamNameMatch) {
                            const [_, name, rank, kills, rankScore, totalScore] = teamNameMatch;
                            if (!teamData[name]) {
                                teamData[name] = {
                                    kills: 0,
                                    totalScore: 0,
                                    booyah: 0
                                };
                            }
                            teamData[name].kills += parseInt(kills, 10);
                            teamData[name].totalScore += parseInt(totalScore, 10);
                            teamData[name].booyah += (parseInt(rank, 10) === 1) ? 1 : 0;
                        }

                        // Processamento dos dados dos jogadores
                        const playerNameMatch = line.match(/^NAME:\s*(.+?)\s+ID:\s*\d+\s+KILL:\s*(\d+)$/);
                        if (playerNameMatch) {
                            const [_, playerName, kills] = playerNameMatch;
                            if (!playerData[playerName]) {
                                playerData[playerName] = 0;
                            }
                            playerData[playerName] += parseInt(kills, 10);
                        }
                    });

                    // Atualiza a tabela de equipes
                    updateTeamTable(teamData);
                    // Atualiza a tabela de jogadores
                    updatePlayerTable(playerData);
                };
                reader.readAsText(file);
            });
        }

        function updateTeamTable(teamData) {
            const tableBody = document.querySelector('#resultTable tbody');
            tableBody.innerHTML = '';

            const sortedTeams = Object.keys(teamData).map(team => ({
                name: team,
                ...teamData[team]
            })).sort((a, b) => {
                if (b.totalScore === a.totalScore) {
                    return b.kills - a.kills;
                }
                return b.totalScore - a.totalScore;
            });

            let position = 1;
            sortedTeams.forEach(team => {
                const { name, kills, totalScore, booyah } = team;
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${position++}</td>
                    <td>${name}</td>
                    <td>${kills}</td>
                    <td>${totalScore}</td>
                    <td>${booyah}</td>
                `;
                tableBody.appendChild(row);
            });

            document.getElementById('resultTable').classList.remove('hidden');
        }

        function updatePlayerTable(playerData) {
            const tableBody = document.querySelector('#playerTable tbody');
            tableBody.innerHTML = '';

            const sortedPlayers = Object.keys(playerData).map(player => ({
                name: player,
                kills: playerData[player]
            })).sort((a, b) => b.kills - a.kills);

            let position = 1;
            sortedPlayers.forEach(player => {
                const { name, kills } = player;
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${position++}</td>
                    <td>${name}</td>
                    <td>${kills}</td>
                `;
                tableBody.appendChild(row);
            });

            document.getElementById('playerTable').classList.remove('hidden');
        }

        function exportToExcel() {
            const wb = XLSX.utils.book_new();
            wb.Props = {
                Title: "Resultados",
                Subject: "Resultados",
                Author: "Autor",
                CreatedDate: new Date()
            };

            // Adiciona a tabela de equipes
            const teamTable = document.getElementById('resultTable');
            const teamData = Array.from(teamTable.querySelectorAll('tr')).map(row => Array.from(row.querySelectorAll('td')).map(cell => cell.textContent));
            const teamWs = XLSX.utils.aoa_to_sheet(teamData);
            XLSX.utils.book_append_sheet(wb, teamWs, "Equipes");

            // Adiciona a tabela de jogadores
            const playerTable = document.getElementById('playerTable');
            const playerData = Array.from(playerTable.querySelectorAll('tr')).map(row => Array.from(row.querySelectorAll('td')).map(cell => cell.textContent));
            const playerWs = XLSX.utils.aoa_to_sheet(playerData);
            XLSX.utils.book_append_sheet(wb, playerWs, "Jogadores");

            XLSX.writeFile(wb, "resultados.xlsx");
        }
    </script>
</body>
</html>
